var config={pageSize:12,pageIndex:1,viewport:{width:189,height:245}},bookController={init:function(){bookController.loadData();bookController.loadCategory();bookController.registerEvent()},registerEvent:function(){$(".datepicker").datepicker({format:"mm/dd/yyyy"});$(".Language").select2();$("#txtBookType").select2();$("#EditCategory").select2();$("#txtBookCategory").select2();$("#EditBookType").select2();jQuery.validator.setDefaults({debug:!0,success:"valid"});$("#frmEbook").validate({rules:{Name:{required:!0,minlength:8},Image:"required",PageNumber:{required:!0,min:1,number:!0},Capacity:{required:!0,min:0,number:!0},Authors:"required",DateRelease:{required:!0,min:1980,max:2090,number:!0},EbookType:"required",EbookCategory:"required",LongDescription:{required:!0,minlength:20}},messages:{Name:{required:"Tên là bắt buộc",minlength:"Tên yêu cầu ít nhất 8 ký tự"},Image:"Yêu cầu có ảnh đại diện",PageNumber:{required:"Nhập số trang",min:"Số trang phải ít nhất là 1!",number:"Số trang không hợp lệ!"},Capacity:{required:"Nhập dung lượng",min:"Số trang phải ít nhất là 0!",number:"Dung lượng không hợp lệ!"},Authors:"Nhập tên tác giả",DateRelease:{required:"Yêu cầu nhập năm",min:"Năm lớn hơn 1980",max:"Năm nhỏ hơn 2090",number:"Yêu cầu phải là số"},EbookType:"Yêu cầu nhập thể loại",EbookCategory:"Danh mục",LongDescription:{required:"Yêu cầu nhập mô tả",minlength:"Yêu cầu ít nhất 20 ký tự"}}});$("#frmEditData").validate({rules:{EditName:{required:!0,minlength:8},EditLink:"required",EditImage:"required",PageNumber:{required:!0,min:1,number:!0},Capacity:{required:!0,min:.1,number:!0},Authors:"required",DateRelease:{required:!0,min:1980,max:2090,number:!0},EditBookTypeId:"required",EditCategory:"required",EditLongDescription:{required:!0,minlength:20}},messages:{EditName:{required:"Tên là bắt buộc",minlength:"Tên yêu cầu ít nhất 8 ký tự"},EditLink:"Nhập link download",EditImage:"Yêu cầu có ảnh đại diện",PageNumber:{required:"Nhập số trang",min:"Số trang phải ít nhất là 1!",number:"Số trang không hợp lệ!"},Capacity:{required:"Nhập dung lượng",min:"Tối thiểu phải ít nhất là 0.1!",number:"Dung lượng không hợp lệ!"},Authors:"Nhập tên tác giả",DateRelease:{required:"Yêu cầu nhập năm",min:"Năm lớn hơn 1980",max:"Năm nhỏ hơn 2090",number:"Yêu cầu phải là số"},EditBookTypeId:"Yêu cầu nhập thể loại",EditCategory:"Danh mục",EditLongDescription:{required:"Yêu cầu nhập mô tả",minlength:"Yêu cầu ít nhất 20 ký tự"}}});$("#txtBookCategory,#EditCategory").on("change",function(){var n=$(this).val();n!==null&&bookController.loadTypeByCategory(n)});$("#btnAdd").off("click").on("click",function(){$("#frmEbook").valid()&&bookController.Post()});$("#txtName").on("change",function(){var n=$("#txtName").val();bookController.checkExist(n)});$("#SaveEdit").off("click").on("click",function(){$("#frmEditData").valid()&&bookController.Put()});$(".btn-showTable").off("click").on("click",function(){$(".show-Table").removeClass("hidden");$(".show-Table").show(3e3);$(".show-Colapse").addClass("hidden");$(".show-Colapse").hide(2e3)});$(".btn-showCollapse").off("click").on("click",function(){$(".show-Colapse").removeClass("hidden");$(".show-Colapse").show(2e3);$(".show-Table").addClass("hidden");$(".show-Table").hide(3e3)});$(".btn-active").off("click").on("click",function(n){n.preventDefault();var i=$(this).data("id"),t=$(this);$.ajax({url:"/admin/books/ChangeStatus",data:{id:i},type:"post",dataType:"json",success:function(n){n.message===null?toastr.error(n.message):n.status?(t.removeClass("bg-red"),t.addClass("bg-green"),toastr.remove(),toastr.info("Đã kích hoạt"),t.html("<i class='fa fa-check'>Active<\/i>")):(t.removeClass("bg-green"),t.addClass("bg-red"),toastr.remove(),toastr.info("Đã hủy kích hoạt"),t.html("<i class='fa fa-ban'>NotActive<\/i>"))}})});$(".btn-edit").off("click").on("click",function(){var n=$(this).data("id");$("ul.nav.nav-tabs a:eq(2)").tab("show");bookController.resetForm();bookController.loadDetail(n)});$(".btn-delete").off("click").on("click",function(){var n=$(this).data("id");bootbox.confirm("Bạn có chắc chắn muốn xóa danh mục này không?",function(t){t&&bookController.delete(n)})});$("#btn-Deletemulti").off("click").on("click",function(){bootbox.confirm("Bạn có chắc muốn xóa các bản ghi được chọn không?",function(n){n&&bookController.deleteMul()})});$(".btn-clear").off("click").on("click",function(){$("#txtSearch").val("");bookController.loadData()});$("#txtSearch").keypress(function(n){n.keyCode===13&&bookController.loadData(!0)});$("#btn-refresh").off("click").on("click",function(){$("#txtSearch").val("");bookController.loadData(!0)});$("#selectAll").change(function(){$(".selectedItem").prop("checked",$(this).prop("checked"));$("#btn-Deletemulti").removeAttr("disabled")});$(".selectedItem").on("click",function(){$(this).attr("checked",this.checked?"":"checked")});$(".selectedItem").on("change",function(){var n=$(".selectedItem").attr("checked").length;n>1?$("#btn-Deletemulti").removeAttr("disabled"):$("#btn-Deletemulti").add("disabled")})},"delete":function(n){$.ajax({url:"/admin/Books/Delete",data:{id:n},type:"post",dataType:"json",success:function(){toastr.success("Xóa thành công");bookController.loadData(!0)}})},deleteMul:function(){var n=[];$("td input:checked").each(function(){n.push($(this).data("id"))});n.length===0?toastr.warning("Không có phần tử nào được chọn!"):$.ajax({url:"/admin/books/DeleteMul",data:{ids:n},type:"post",dataType:"json",success:function(n){n.status?(toastr.success(n.message),bookController.loadData(!0)):(toastr.error(n.message),bookController.loadData(!0))}})},resetForm:function(){$("#txtId").val("");$("#txtName").val("");$("#txtMetaName").val("");$("#txtBookType").val("");$("#shortDescription").val("");tinymce.get("txtContent").setContent("")},checkExist:function(n){$.ajax({url:"/admin/books/CheckExist",data:{name:n},type:"post",dataType:"json",success:function(t){t.result===!0?bookController.Post():$(".validate").html("Tên "+n+" đã tồn tại!")}})},loadTypeByCategory:function(n){var t=$("#txtBookType"),i=$("#EditBookType");$.ajax({url:"/admin/booktype/getbycategory",type:"get",data:{categoryId:n},dataType:"json",success:function(n){t.empty();i.empty();var r=n;$(r).each(function(n,r){t.append($("<option/>",{value:r.id,text:r.name}));i.append($("<option/>",{value:r.id,text:r.name}))})}})},loadCategory:function(){var n=$("#txtBookCategory"),t=$("#EditCategory");$.ajax({url:"/admin/Category/GetAll",type:"get",dataType:"json",success:function(i){if(i.status){n.empty();t.empty();var r=i.data;$(r).each(function(i,r){n.append($("<option/>",{value:r.id,text:r.name}));t.append($("<option/>",{value:r.id,text:r.name}))})}}})},loadDetail:function(n){$.ajax({url:"/admin/Books/GetDetail",data:{id:n},type:"POST",dataType:"json",success:function(n){if(n.status===!0){var t=n.data.book,i=n.data.downloadLinks;$("#EditId").val(t.id);$("#EditName").val(t.name);$("#EditLink").val(t.linkDownload);$("#EditThumbnail").attr("src",t.thumbnailUrl);$("#urlImg").val(t.thumbnailUrl);$("#EditMetaName").val(t.metaName);$("#EditPageNumber").val(t.pageNumber);$("#EditCapacity").val(t.cappacity);$("#EditAuthors").val(t.authors);$("#EditPublishBy").val(t.publishBy);$("#EditDateRelease").val(t.dateRelease);$("#EditReferenceText").val(t.textReference);$("#EditReferenceLink").val(t.linkReference);tinymce.get("EditContent").setContent(t.longDescription);$("#EditStatus").prop("checked",t.status);$("#EditLinkId").val(i.id);$("#EditLinkPdf").val(i.pdfLink);$("#EditLinkEpub").val(i.mobiLink);$("#EditLinkMobi").val(i.epubLink)}else toastr.error(n.message),bookController.loadData(!0)}})},Post:function(){var t=$("#txtName").val(),i=commonController.getSeoTitle(t),r=$("#txtBookType").val(),u=$("#txtBookCategory").val(),f=$("#ImgThumbnail").attr("src"),e=tinymce.get("txtContent").getContent(),o=$(".Language").val(),s=$("#txtPageNumber").val(),h=$("#txtCapacity").val(),c=$("#txtAuthors").val(),l=$("#txtPublishBy").val(),a=$("#txtDateRelease").val(),v=$("#txtReferenceText").val(),y=$("#txtReferenceLink").val(),p=$("#txtStatus").prop("checked"),w=$("#txtLinkPdf").val(),b=$("#txtLinkEpub").val(),k=$("#txtLinkMobi").val(),n={PdfLink:w,EpubLink:b,MobiLink:k},d={Name:t,Language:o,PageNumber:s,Authors:c,TextReference:v,LinkReference:y,DateRelease:a,PublishBy:l,Cappacity:h,MetaName:i,BookTypeId:r,CategoryId:u,ThumbnailUrl:f,LongDescription:e,Status:p};n.PdfLink!==""||n.EpubLink!==""||n.MobiLink!==""?$.ajax({url:"/admin/Books/Post",data:{book:JSON.stringify(d),downloadLink:JSON.stringify(n)},type:"post",dataType:"json",success:function(n){n.status?(location.reload(),toastr.success(n.message)):toastr.error(n.message)}}):alert("Vui lòng cung cấp ít nhất một đường dẫn download!")},Put:function(){var i=$("#EditId").val(),t=$("#EditName").val(),r=commonController.getSeoTitle(t),u=$("#EditThumbnail").attr("src"),f=$("#EditBookType").val(),e=$("#EditCategory").val(),o=tinymce.get("EditContent").getContent(),s=$("#EditLanguage").val(),h=$("#EditPageNumber").val(),c=$("#EditCapacity").val(),l=$("#EditAuthors").val(),a=$("#EditPublishBy").val(),v=$("#EditDateRelease").val(),y=$("#EditReferenceText").val(),p=$("#EditReferenceLink").val(),w=$("#EditStatus").prop("checked"),b=$("#EditLinkId").val(),k=$("#EditLinkPdf").val(),d=$("#EditLinkEpub").val(),g=$("#EditLinkMobi").val(),n={Id:b,PdfLink:k,EpubLink:d,MobiLink:g},nt={ID:i,Name:t,Language:s,PageNumber:h,Authors:l,TextReference:y,LinkReference:p,DateRelease:v,PublishBy:a,Cappacity:c,MetaName:r,BookTypeId:f,CategoryId:e,ThumbnailUrl:u,LongDescription:o,Status:w};n.PdfLink!==""||n.EpubLink!==""||n.MobiLink!==""?$.ajax({url:"/admin/Books/Put",data:{book:JSON.stringify(nt),downloadLink:JSON.stringify(n)},type:"post",dataType:"json",success:function(n){n.status?(location.reload(),toastr.success(n.message)):toastr.error(n.message)}}):alert("Vui lòng cung cấp ít nhất một đường dẫn download!")},loadData:function(n){var t=$("#txtSearch").val();$.ajax({url:"/admin/Books/GetAll",type:"GET",data:{filter:t,page:config.pageIndex,pageSize:config.pageSize},dataType:"json",success:function(t){var r;if(t.status){var u=t.data,i="",f=$("#data-template").html();$.each(u,function(n,t){i+=Mustache.render(f,{ID:t.id,Name:t.name,Image:t.thumbnailUrl,CreatedDate:$.datepicker.formatDate("dd-mm-yy",new Date(t.createdDate)),CreatedBy:t.userName,CountDown:t.countDownload,Status:t.status?" <a href='#' class='btn-active badge bg-green' data-id='"+t.id+"'><i class='fa fa-check'>Active<\/i><\/a>":"<a href='#' class='btn-active badge bg-red' data-id='"+t.id+"'><i class='fa fa-ban'>NotActive<\/i><\/a>"})});$("#tbData").html(i);r=Math.ceil(t.total/config.pageSize);bookController.paging(t.total,function(){bookController.loadData();$("#currentpage").html(config.pageIndex);$("#totalpage").html(r)},n);bookController.registerEvent()}}})},paging:function(n,t,i){var r=Math.ceil(n/config.pageSize);($("#pagination a").length===0||i===!0)&&($("#pagination").empty(),$("#pagination").removeData("twbs-pagination"),$("#pagination").unbind("page"));$("#pagination").twbsPagination({totalPages:r,first:"Đầu",prev:"Trước",next:"Tiếp ",last:"Cuối",visiblePages:10,onPageClick:function(n,i){config.pageIndex=i;setTimeout(t,200)}})}};bookController.init();